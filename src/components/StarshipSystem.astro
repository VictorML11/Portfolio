---
// src/components/StarshipSystem.astro
import StarshipGraphic from "./StarshipGraphic.astro";
import StarshipOfLogo from "./StarshipOfLogo.astro";
---

<div
    id="starship-system"
    class="fixed inset-0 pointer-events-none -z-5 overflow-hidden"
>
    <div
        class="ship-wrapper absolute w-24 h-24 opacity-0 will-change-transform"
        data-rotation-offset="-90"
        data-speed-min="15"
        data-speed-max="30"
    >
        <StarshipGraphic />
    </div>

    <div
        class="ship-wrapper absolute w-32 h-32 opacity-0 will-change-transform"
        data-rotation-offset="-90"
        data-speed-min="25"
        data-speed-max="45"
    >
        <StarshipOfLogo />
    </div>
</div>

<script>
    const ships = document.querySelectorAll(".ship-wrapper");

    ships.forEach((shipElement, index) => {
        const ship = shipElement as HTMLElement;
        const offset = parseFloat(ship.dataset.rotationOffset || "0");
        const speedMin = parseFloat(ship.dataset.speedMin || "20");
        const speedMax = parseFloat(ship.dataset.speedMax || "40");

        // Stagger start times so they don't launch together
        setTimeout(() => {
            launchShip(ship, offset, speedMin, speedMax);
        }, index * 5000); // 5 second gap between first launches
    });

    function launchShip(
        ship: HTMLElement,
        rotationOffset: number,
        minSpeed: number,
        maxSpeed: number,
    ) {
        const w = window.innerWidth;
        const h = window.innerHeight;
        const buffer = 200;

        // Pick a random start side (0-3)
        const startSide = Math.floor(Math.random() * 4);
        let startX, startY, endX, endY;

        switch (startSide) {
            case 0: // Top -> Bottom
                startX = Math.random() * w;
                startY = -buffer;
                endX = Math.random() * w;
                endY = h + buffer;
                break;
            case 1: // Right -> Left
                startX = w + buffer;
                startY = Math.random() * h;
                endX = -buffer;
                endY = Math.random() * h;
                break;
            case 2: // Bottom -> Top
                startX = Math.random() * w;
                startY = h + buffer;
                endX = Math.random() * w;
                endY = -buffer;
                break;
            case 3: // Left -> Right
                startX = -buffer;
                startY = Math.random() * h;
                endX = w + buffer;
                endY = Math.random() * h;
                break;
        }

        // Calculate Angle
        const dx = endX! - startX!;
        const dy = endY! - startY!;
        const angleRad = Math.atan2(dy, dx);
        const angleDeg = (angleRad * 180) / Math.PI + rotationOffset;

        // Random Speed
        const duration =
            (Math.random() * (maxSpeed - minSpeed) + minSpeed) * 1000;

        // Animation Keyframes
        const keyframes = [
            {
                transform: `translate(${startX}px, ${startY}px) rotate(${angleDeg}deg) scale(0.8)`,
                opacity: 0,
            },
            { opacity: 0.5, offset: 0.1 },
            { opacity: 0.5, offset: 0.9 },
            {
                transform: `translate(${endX}px, ${endY}px) rotate(${angleDeg}deg) scale(0.8)`,
                opacity: 0,
            },
        ];

        const animation = ship.animate(keyframes, {
            duration: duration,
            easing: "linear",
            iterations: 1,
        });

        animation.onfinish = () => {
            // Random delay before next pass
            setTimeout(() => {
                launchShip(ship, rotationOffset, minSpeed, maxSpeed);
            }, Math.random() * 3000);
        };
    }
</script>
